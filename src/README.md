# Source

The `OEM` folder contains the disassembled source code to an original boot disk generated on a Apple //e with the Cirtech CP/M plus hardware. This code contains hardware checks for the Cirtech hardware and fails to boot correctly on emulated hardware. (The patches required are minimal, search for `CC6502`)

The `patched` folder contains a patched BIOS plus binary files from RomWBW that have had CP/M plus patches applied.

## Tools required

Binaries for tools that run under CP/M are in the tools folder.
NTVCM from https://github.com/davidly/ntvcm has been used to run the CP/M binaries under windows and is expected to be at `c:\tools\ntvcm.exe`, however other CP/M 2.2 emulators (e.g. ZXCC) should work with some tweaks to the build scripts.

The Microsoft .net 8.0 SDK is needed to build tools used to
- add and remove CP/M Ctrl-Z from the source code.
- Extract files for binary comparison from a disk image.

For the original patch free `GENCPM.COM`, `BDOS3.SPR`, `BNKBDOS3.SPR` and `RESBDOS3.SPR` I've used files found in the `CPM3/FLOPPY` folder of `TARBELL.ZIP` from http://www.retroarchive.org/cpm/os/os.htm the only changes made to the SPR files has been to patch the correct CP/M Plus serial number in for the Cirtech distribution disk I have. These live in the `OEM/gencpm` folder.

*Note* the sectors on the first three tracks are in ProDOS sector order.

|Track| Sectors | 6502 load address | Z80 Address | Code |
|-----|---------|-------------------|-------------|------|
| 0   | 0-1     | `$0800` | NA |initial 6502 boot sector. |
| 0   | 2-F     | `$D000` | NA | 6502 BIOS code. |
| 1   | 0-C     | `$1100` | `0100H` | CCP.COM |
| 1   | D-F     | `$1E00` | `0E00H` | Cirtech toolkit strings |
| 2   | 0-F     | `$2100` | `1100H` | CPMLDR.COM - CP/M loader |

The `build.ps1` powershell script runs the NibReader tool over an image created from a
Cirtech CP/M boot disk, creating `.BIN` binary image files plus `CPM3.SYS` in the `comparison` folder. It then builds the assembler files and links them into `.BIN` files and `BNKBIOS3.SPR` file for `GENCPM.COM`. 

Gencpm is run to generate `CPM3.SYS` and the results placed into the `binaries` folder.

It compares the files from the `comparison` folder generated by the NibReader with binaries built and linked in the `binaries` folder. 

## Patched folder

The patched build folder uses the patched SPR files from the RomWBW project as these contain the DRI patch sets. It also uses the binaries for CP/M plus utilties (`PIP.COM`, `DIR.COM`, `DATE.COM` etc) from RomWBW. 

Code patches applied:
- `BIOS.MAC` - Checks for the Cirtech CP/M plus Apple //e physical hardware which it is suspected used the address mapping PROM with an alternative mapping have been removed.
- `BIOSCHAR.MAC` - The 6850 ACIA based card driver (for the CCS7710 or Apple ][ communications card ]) now no longer overwrites an input character. _Note_ this is untested until I plug the CCS7710 I have into physical hardware.
- `BIOSDISK.MAC` - No changes currently, although the disk formatter routine track nibble gap sizing routine looks like it is jumping to an incorrect location when wasting cycles.
- `BIOSVID.MAC` - Now has an cursor up command and correctly implements the Soroq IQ-120

Currently this builds a `system.dsk` in the binaries folder which is capable of being booted under AppleWin and Mame. The Utility disk is still on the todo list.

For details of the video card patches please see [video-bios-patch.md](video-bios-patch.md)

## TO DO

~Write a utility to generate a bootable Apple ][ .DSK image~

~Add a patched version of CP/M plus bootable with mame / AppleWin with a Softcard emulated.~

Write 6502 / Z80 code to test the possible memory remapper that is being used to detect the Cirtech card. This should help with figuring out why the main code use 0E401H to swap between Z80 and 6502 code

Add source code for the utility disk and build steps to generate it.

Possibly add Cirtech CP/M emulation to mame / AppleWin.

Trace through the boot process for the Apple //GS based CP/M boot image found on archive.org which would allow booting from a file on a ProDOS partition.
